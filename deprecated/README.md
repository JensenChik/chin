# 轻量级分布式调度系统--秦(chin)
## 简介
chin 是一个支持定时&依赖的轻量级分布式调度系统，相比于Linkin开源的azkaban调度系统，它占用的内存更少；相比于Airbnb开源的AirFlow调度系统，它占用的CPU更少；相比于Luigi以及上述两者，它管理界面更友好。

由于是轻量级系统，因此它很容易移植到ARM系列的处理器上(事实上我正是为了解决上述系统无法在ARM架构的机器下正常工作而写的这个调度系统)。它可以执行所有的linux命令，包括但并不只局限于

* command
* shell
* python
* java
* etc...

由于是利用下班之余开发的，所以填坑速度会很慢，fork me are welcome :D

## 工程结构
```
chin
┣━ app/app: android端
┃   ┣━ src
┃   ┃   ┣━ main
┃   ┃   ┃   ┣━ java/space/conj/chin:android核心代码
┃   ┃   ┃   ┃    ┣━ activity: andoroid activity
┃   ┃   ┃   ┃    ┣━ adapter: 自定义适配器
┃   ┃   ┃   ┃    ┣━ bean: java bean
┃   ┃   ┃   ┃    ┣━ layout: 自定义布局
┃   ┃   ┃   ┃    ┗━ tools: 工具类
┃   ┃   ┃   ┗━ res:资源
┃   ┃   ┃
┃   ┃   ┗━ test:单元测试
┃   ┗━ build.gradle: gradle配置
┃
┣━ core: 调度器核心
┃   ┣━ scheduler: master逻辑
┃   ┗━ worker: slave逻辑
┃
┣━ model: 数据库表定义
┃
┣━ webserver: www端
┃   ┣━ main: web核心逻辑
┃   ┣━ static: web静态资源
┃   ┗━ templates: jinja2渲染模板
┃
┣━ chin.ini.template: 配置文件模板
┣━ chin.py: 启动脚本
┗━ requirements.txt: python依赖
```


## 系统设计
系统采用无状态设计，master & slaver 架构，可以很容易地对 slaver 进行横向扩展。整个系统大致分为四个组件

* MySQL(1个)：用于存储元数据 & 系统日志
* JobTracker(1个)：用于分配任务 & 跟踪任务执行情况，也就是master
* TaskTracker(n个)：用于执行任务，也就是slaver
* WebServer(1个)：用于可视化关系调度系统

这些组件可以部署在不同的机器上，也可以部署在同一台机器上，取决于你的任务量有多大 or 你有多少~~钱~~机器

### MySQL
整个系统中,MySQL是核心，所有的组件都围绕MySQL进行通讯，如果MySQL挂了，那所有组件都不能工作了,我们称之为：真·药丸
表设计如下:

* task：记录任务的元数据，比如任务名、创建者、执行命令、调度格式、任务依赖、机器池、重跑机制....
* task_instance：记录任务具体执行的数据，比如版本号、实际执行的机器、乱七八糟的时间、执行状态&日志....
* user：用于权限管理的用户表，没啥好说的
* action：用于记录用户重要的操作信息，防止被你的SB同事/同学/室友乱操作并拒不承认
* 更多的坑还没填

### JobTracker
包工头，用于计划工作&分配工作，它要是挂了，WebServer还能正常工作，但不不再会有任务调度

* 每天凌晨会生成当天要执行的版本号,也就是凌晨的时候就已经决定好今天要做那些工作了
* 一天中不断地扫描数据库，当发现有任务应该执行了，就根据机器的负载（待填坑）分配机器
* 当发现有任务失败了，就自动发送报警邮件

### TaskTracker
醒工砖，用于执行包工头分配的任务，它要是挂了，包工头会找下一个替代他，万一所有的都挂了，那就积累一批砖没人搬了

* 每天不断地扫描数据库，当发现有分配给自己的任务时执行它
* 询问任务的进展，当任务失败/成功时回写状态&任务输出日志到数据库里
* 将自身负载更新到数据库中

### WebServer
甲方，给包工头增删改查任务，分分钟让你 重跑 or 马上执行 or 中止 or 汇报工作 or 乱七八糟的需求

## 工作流程

## 使用指南
### 安装
....待填坑
### 配置
....待填坑
### 任务管理
....待填坑
### 日志管理
....待填坑
### 机器管理
....待填坑
### 用户管理
....待填坑

## todo list
* 负载均衡
* 重跑机制
* 用户组权限管理
* 一键部署
* 机器状态可视化
* 任务依赖可视化
* api化
